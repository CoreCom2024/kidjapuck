{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ room.property.name }} · {{ room.name }}{% endblock %}

{% block content %}
<div class="container-fluid px-0">
  <div class="row g-0">
    <div class="col-12">
      {% if room.images.all %}
        <div id="roomGallery" class="carousel slide">
          <div class="carousel-inner">
            {% for img in room.images.all %}
              <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img src="{{ img.image.url }}" class="d-block w-100 object-fit-cover" style="max-height: 460px;">
              </div>
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#roomGallery" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#roomGallery" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="container my-4">
  <div class="row g-4">
    <div class="col-lg-8">
      <h1 class="h4 mb-1">{{ room.property.name }} · {{ room.name }}</h1>
      <p class="text-muted mb-3">
        <i class="bi bi-geo-alt"></i> {{ room.property.address|default:"" }}
      </p>

      <div class="d-flex align-items-center gap-2 mb-3">
        <span class="badge bg-dark rounded-pill"><i class="bi bi-people-fill"></i> รองรับ {{ room.max_guests }} คน</span>
      </div>

      <hr class="my-3">

      <h2 class="h6">รายละเอียด</h2>
      <ul class="text-muted mb-4">
        <li>เช็คอิน/เช็คเอาต์ยืดหยุ่นตามนโยบายที่พัก</li>
        <li>ราคาขึ้นกับจำนวนผู้เข้าพัก และกฎราคา (RoomPriceRule)</li>
      </ul>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <form method="get" class="mb-3">
            <div class="row g-2 align-items-end">
              <div class="col-12">
                <label class="form-label">เช็คอิน</label>
                <input type="date" name="start_date" class="form-control"
                       value="{{ start_date|date:'Y-m-d' }}" required>
              </div>
              <div class="col-12">
                <label class="form-label">เช็คเอาต์</label>
                <input type="date" name="end_date" class="form-control"
                       value="{{ end_date|date:'Y-m-d' }}" required>
              </div>
              <div class="col-12">
                <label class="form-label">ผู้เข้าพัก</label>
                <input type="number" name="guests" class="form-control" min="1" step="1"
                       value="{{ guests|default:1 }}">
              </div>
              <div class="col-12 d-grid mt-2">
                <button class="btn btn-primary">
                  <i class="bi bi-arrow-repeat"></i> คำนวณราคาใหม่
                </button>
              </div>
            </div>
          </form>

          {% if start_date and end_date %}
          <p class="text-muted small mb-2">
            <i class="bi bi-calendar-event"></i>
            {{ start_date|date:"j M Y" }} – {{ end_date|date:"j M Y" }}
            {% if nights %} • {{ nights }} คืน{% endif %}
            • ผู้เข้าพัก {{ guests }} คน
          </p>
          {% endif %}

          {% if total_price %}
            <div class="mb-2">
              <div class="text-muted small">ราคารวม</div>
              <div class="fs-4 fw-bold text-primary">
                {{ total_price|floatformat:0|intcomma }} บาท
              </div>
              {% if avg_price %}
              <div class="text-muted small">เฉลี่ยต่อคืน ~ {{ avg_price|floatformat:0|intcomma }} บาท/คืน</div>
              {% endif %}
            </div>
            {% if has_conflict %}
              <div class="alert alert-warning py-2 small mb-2">
                ช่วงเวลานี้ถูกจอง/ถูกปิดไว้บางส่วน โปรดเลือกวันที่ใหม่
              </div>
            {% else %}
              <a class="btn btn-success w-100 disabled" aria-disabled="true">
                จองเลย (demo)
              </a>
              <div class="form-text">*ปุ่มจองไว้เป็นตัวอย่าง — ต่อเชื่อม flow การจองภายหลัง</div>
            {% endif %}
          {% else %}
            <div class="text-muted">ยังไม่ตั้งราคา/ยังไม่เลือกวันที่</div>
          {% endif %}
        </div>
      </div>

      <div class="card border-0 shadow-sm mt-3">
        <div class="card-body">
          <div class="d-grid gap-2">
            <a class="btn btn-outline-secondary"
               href="{% url 'properties:search' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&guests={{ guests }}">
              <i class="bi bi-arrow-left"></i> กลับไปหน้าค้นหา
            </a>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ให้ end_date อย่างน้อย start+1
  (function() {
    const start = document.querySelector('input[name="start_date"]');
    const end   = document.querySelector('input[name="end_date"]');
    function clampEndMin() {
      if (!start.value) return;
      const d = new Date(start.value);
      d.setDate(d.getDate() + 1);
      const minStr = d.toISOString().slice(0, 10);
      end.min = minStr;
      if (end.value && end.value < minStr) end.value = minStr;
    }
    start.addEventListener('change', clampEndMin);
    window.addEventListener('load', clampEndMin);
  })();
</script>
{% endblock %}